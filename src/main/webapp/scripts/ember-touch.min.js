// ==========================================================================
// Project:   Ember Touch - Touch and Gesture Library For Ember
// Copyright: ©2006-2011 Strobe Inc. and contributors.
//            Portions ©2008-2011 Apple Inc. All rights reserved.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================

(function(a){var b=Em.get,c=Em.set;Em.Gestures=Em.Object.create({_registeredGestures:null,init:function(){return this._registeredGestures={},this._super()},register:function(a,b){var c=this._registeredGestures;if(c[a]!==undefined)throw new Em.Error(a+" already exists as a registered gesture recognizers. Gesture recognizers must have globally unique names.");c[a]=b},unregister:function(a){var b=this._registeredGestures;b[a]!==undefined&&(b[a]=undefined)},knownGestures:function(){var a=this._registeredGestures;return a?a:{}}})})({}),function(a){Em.AppGestureManager=Em.Object.create({_isBlocked:!1,_blockerView:null,isBlocked:Em.computed(function(){return this.get("_isBlocked")}).property("_isBlocked"),wasBlockedBy:function(a){return a===this.get("_blockerView")},block:function(a){if(this.get("isBlocked"))throw Error("manager has already blocked the gesture recognizer");if(a.get("simultaneosly"))throw Error("a view with simultaneosly property true, cannot block the gesture recognizer");this.set("_isBlocked",!0),this.set("_blockerView",a)},unblock:function(a){if(!this.get("isBlocked"))throw Error("unblock, the gesture recognizer when the recognizer was not blocked. Did you unblock after Start? ");if(a.get("simultaneosly"))throw Error("a view with simultaneosly property true, cannot unblock the gesture recognizer");var b=this.get("_blockerView");if(a!==b)throw Error("unblock a view which was not the one which blocked the gesture recognizer");this.set("_isBlocked",!1)},restart:function(){this.set("_isBlocked",!1),this.set("_blockerView",null)}})}({}),function(a){var b=Em.get,c=Em.set;Em.GestureManager=Em.Object.extend({gestures:null,view:null,touchStart:function(a,b){return this._invokeEvent("touchStart",a)},touchMove:function(a,b){return this._invokeEvent("touchMove",a)},touchEnd:function(a,b){return this._invokeEvent("touchEnd",a)},touchCancel:function(a,b){return this._invokeEvent("touchCancel",a)},_invokeEvent:function(a,b){var c=this.get("gestures"),d,e,f=!0;for(var g=0,h=c.length;g<h;g++){d=c[g],e=d[a];if(Em.typeOf(e)==="function"){var i=d.get("delegate");if(!i||i.shouldReceiveTouch(d,this.view,b))f=e.call(d,b)}}var j=this.view.get("parentView");if(j){var k=j.get("eventManager");k&&k._invokeEvent(a,b)}return f}})}({}),function(a){var b=Em.get,c=Em.set;Em.TouchList=Em.Object.extend({touches:null,timestamp:null,init:function(){this._super(),c(this,"touches",[])},addTouch:function(a){var c=b(this,"touches");c.push(a),this.notifyPropertyChange("touches")},updateTouch:function(a){var c=b(this,"touches");for(var d=0,e=c.length;d<e;d++){var f=c[d];if(f.identifier===a.identifier){c[d]=a,this.notifyPropertyChange("touches");break}}},removeTouch:function(a){var c=b(this,"touches");for(var d=0,e=c.length;d<e;d++){var f=c[d];if(f.identifier===a.identifier){c.splice(d,1),this.notifyPropertyChange("touches");break}}},removeAllTouches:function(){c(this,"touches",[])},touchWithId:function(a){var c=null,d=b(this,"touches");for(var e=0,f=d.length;e<f;e++){var g=d[e];if(g.identifier===a){c=g;break}}return c},length:Ember.computed(function(){var a=b(this,"touches");return a.length}).property("touches").cacheable()})}({}),function(a){var b=Em.get,c=Em.set,d=100;Em.Gesture=Em.Object.extend({state:null,name:null,view:null,gestureIsDiscrete:!1,preventDefaultOnChange:!1,simultaneously:!0,appGestureManager:null,touches:null,numberOfActiveTouches:0,numberOfRequiredTouches:1,delegateName:null,delegate:null,init:function(){this._super(),this.touches=Em.TouchList.create();var a=this.get("delegateName"),b=this.get("delegate");if(!b&&a){var b=Em.GestureDelegates.find(a);ember_assert("empty delegate, attempting to set up delegate based on delegateName",b),this.set("delegate",b)}},didBecomePossible:function(){},shouldBegin:function(){return!0},didBegin:function(){},didChange:function(){},eventWasRejected:function(){},shouldEnd:function(){return!0},didEnd:function(){},didCancel:function(){},simultaneouslyAllowed:function(){var a=!0;return this.simultaneously||(this.manager.appGestureManager.get("isBlocked")?a=this.manager.appGestureManager.wasBlockedBy(this.view):this.manager.appGestureManager.block(this.view)),a},attemptGestureEventDelivery:function(a){var b=this.notifyViewOfGestureEvent(a);b||this.eventWasRejected()},distance:function(a){if(a.length<2)return 0;var b=a[0],c=a[1],d=b.pageX,e=b.pageY,f=c.pageX,g=c.pageY;return Math.sqrt((d-=f)*d+(e-=g)*e)},centerPointForTouches:function(a){var b=0,c=0;for(var d=0,e=a.length;d<e;d++){var f=a[d];b+=f.pageX,c+=f.pageY}var g={x:b/a.length,y:c/a.length};return g},_objectValues:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},notifyViewOfGestureEvent:function(a,b){var c=this.view[a],d=!1;return Em.typeOf(c)==="function"&&(d=c.call(this.view,this,b)),d},toString:function(){return Em.Gesture+"<"+Em.guidFor(this)+">"},_resetState:function(){this.touches.removeAllTouches()},touchStart:function(a){var d=a.originalEvent.targetTouches,e=this.touches,f=b(this,"state");c(e,"timestamp",Date.now());for(var g=0,h=d.length;g<h;g++){var i=d[g];e.touchWithId(i.identifier)===null&&(e.get("length")===b(this,"numberOfRequiredTouches")&&e.removeAllTouches(),e.addTouch(i))}e.get("length")<b(this,"numberOfRequiredTouches")?c(this,"state",Em.Gesture.WAITING_FOR_TOUCHES):this.gestureIsDiscrete?this.shouldBegin()&&this.simultaneouslyAllowed()&&(c(this,"state",Em.Gesture.BEGAN),this.didBegin()):(c(this,"state",Em.Gesture.POSSIBLE),this.didBecomePossible())},touchMove:function(a){var d=b(this,"state");if(d===Em.Gesture.WAITING_FOR_TOUCHES||d===Em.Gesture.ENDED||d===Em.Gesture.CANCELLED)return;var e=a.originalEvent.changedTouches,f=this.touches;c(f,"timestamp",Date.now());for(var g=0,h=e.length;g<h;g++){var i=e[g];f.updateTouch(i)}if(d===Em.Gesture.POSSIBLE&&!this.gestureIsDiscrete)this.shouldBegin()&&this.simultaneouslyAllowed()&&(c(this,"state",Em.Gesture.BEGAN),this.didBegin(),this.didChange(),this.preventDefaultOnChange&&a.preventDefault(),this.attemptGestureEventDelivery(b(this,"name")+"Start"));else if(d===Em.Gesture.BEGAN||d===Em.Gesture.CHANGED)c(this,"state",Em.Gesture.CHANGED),this.didChange(),this.preventDefaultOnChange&&a.preventDefault(),this.gestureIsDiscrete||this.attemptGestureEventDelivery(b(this,"name")+"Change")},touchEnd:function(a){var d=b(this,"state"),e=this.touches;c(e,"timestamp",Date.now());var f=a&&a.originalEvent?a.originalEvent.changedTouches:undefined;if(f)for(var g=0,h=f.length;g<h;g++){var i=f[g];e.updateTouch(i)}this.gestureIsDiscrete?(d===Em.Gesture.BEGAN||d===Em.Gesture.CHANGED)&&this.shouldEnd()&&(c(this,"state",Em.Gesture.ENDED),this.didEnd(),this.attemptGestureEventDelivery(b(this,"name")+"End")):(d===Em.Gesture.BEGAN||d===Em.Gesture.CHANGED)&&this.shouldEnd()&&(c(this,"state",Em.Gesture.ENDED),this.didEnd(),this.attemptGestureEventDelivery(b(this,"name")+"End")),this._resetState()},touchCancel:function(a){var d=b(this,"state");d!==Em.Gesture.CANCELLED&&(c(this,"state",Em.Gesture.CANCELLED),this.didCancel(),this.gestureIsDiscrete||this.notifyViewOfGestureEvent(b(this,"name")+"Cancel")),this._resetState()},_stateToString:function(a){var b="NONE";switch(a){case Em.Gesture.WAITING_FOR_TOUCHES:b="WAITING_FOR_TOUCHES";break;case Em.Gesture.POSSIBLE:b="POSSIBLE";break;case Em.Gesture.BEGAN:b="BEGAN";break;case Em.Gesture.CHANGED:b="CHANGED";break;case Em.Gesture.ENDED:b="ENDED";break;case Em.Gesture.CANCELLED:b="CANCELLED"}return b}}),Em.GestureDirection={Vertical:1,Horizontal:2},Em.OneGestureDirection={Right:1,Left:2,Down:4,Up:8},Em.Gesture.WAITING_FOR_TOUCHES=0,Em.Gesture.POSSIBLE=1,Em.Gesture.BEGAN=2,Em.Gesture.CHANGED=3,Em.Gesture.ENDED=4,Em.Gesture.CANCELLED=5}({}),function(a){var b=Em.get,c=Em.set,d=100;Em.PinchGestureRecognizer=Em.Gesture.extend({scale:1,numberOfRequiredTouches:2,_startingDistanceBetweenTouches:null,_previousTimestamp:null,_previousDistance:0,_deltaThreshold:5,_previousScale:1,didBecomePossible:function(){this._startingDistanceBetweenTouches=this.distance(b(this.touches,"touches")),this._previousDistance=this._startingDistanceBetweenTouches,this._previousTimestamp=b(this.touches,"timestamp")},shouldBegin:function(){var a=this.distance(b(this.touches,"touches"));return Math.abs(a-this._startingDistanceBetweenTouches)>=this._deltaThreshold},didChange:function(){var a=this._previousScale=b(this,"scale"),d=this.touches.timestamp-this._previousTimestamp,e=this.distance(b(this.touches,"touches")),f=e-this._previousDistance;c(this,"velocity",f/d),c(this,"scale",e/this._previousDistance),this._previousTimestamp=b(this.touches,"timestamp"),this._previousDistance=e},eventWasRejected:function(){c(this,"scale",this._previousScale)}}),Em.Gestures.register("pinch",Em.PinchGestureRecognizer)}({}),function(a){var b=Em.get,c=Em.set,d=0;Em.PanGestureRecognizer=Em.Gesture.extend({translation:null,initThreshold:5,direction:Em.GestureDirection.Horizontal|Em.GestureDirection.Vertical,_previousLocation:null,_previousTranslation:null,init:function(){this._super(),c(this,"translation",{x:0,y:0})},didBecomePossible:function(){this._previousLocation=this.centerPointForTouches(b(this.touches,"touches"))},shouldBegin:function(){var a=this._previousLocation,c=this.centerPointForTouches(b(this.touches,"touches")),d=a.x,e=a.y,f=c.x,g=c.y,h=!1;return this.direction&Em.GestureDirection.Vertical&&(h=Math.abs(e-g)>=this.initThreshold),!h&&this.direction&Em.GestureDirection.Horizontal&&(h=Math.abs(d-f)>=this.initThreshold),h},didChange:function(){var a=this._previousLocation,d=this.centerPointForTouches(b(this.touches,"touches")),e={x:d.x,y:d.y};e.x=d.x-a.x,e.y=d.y-a.y,this._previousTranslation=b(this,"translation"),c(this,"translation",e),this._previousLocation=d},eventWasRejected:function(){c(this,"translation",this._previousTranslation)},toString:function(){return Em.PanGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("pan",Em.PanGestureRecognizer)}({}),function(a){var b=Em.get,c=Em.set;Em.TapGestureRecognizer=Em.Gesture.extend({numberOfTaps:1,delayBetweenTaps:500,tapThreshold:10,gestureIsDiscrete:!0,_initialLocation:null,_waitingTimeout:null,_waitingForMoreTouches:!1,_internalTouches:null,init:function(){this._super(),this._internalTouches=Em.TouchList.create(),ember_assert(b(this,"numberOfRequiredTouches")===1,"TODO: still not prepared for higher number")},shouldBegin:function(){return b(this.touches,"length")===b(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(b(this.touches,"touches")),this._internalTouches.addTouch(this.touches[0]),this._waitingForMoreTouches=b(this._internalTouches,"length")<b(this,"numberOfTaps");if(this._waitingForMoreTouches){var a=this;this._waitingTimeout=window.setTimeout(function(){a._waitingFired(a)},this.delayBetweenTaps)}},shouldEnd:function(){var a=this.centerPointForTouches(b(this.touches,"touches")),c=this._initialLocation.x,d=this._initialLocation.y,e=a.x,f=a.y,g=Math.sqrt((c-=e)*c+(d-=f)*d);return Math.abs(g)<this.tapThreshold&&!this._waitingForMoreTouches},didEnd:function(){window.clearTimeout(this._waitingTimeout),this._initialLocation=null,this._internalTouches.removeAllTouches()},_waitingFired:function(){this._initialLocation=null,this._internalTouches.removeAllTouches(),c(this,"state",Em.Gesture.CANCELLED);var a=b(this,"name")+"Cancel";this.attemptGestureEventDelivery(a),this._resetState()},toString:function(){return Em.TapGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("tap",Em.TapGestureRecognizer)}({}),function(a){var b=Em.get,c=Em.set;Em.PressGestureRecognizer=Em.Gesture.extend({pressPeriodThreshold:500,gestureIsDiscrete:!0,_initialLocation:null,_moveThreshold:10,_initialTimestamp:null,shouldBegin:function(){return b(this.touches,"length")===b(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(b(this.touches,"touches")),this._initialTimestamp=b(this.touches,"timestamp")},shouldEnd:function(){var a=this.centerPointForTouches(b(this.touches,"touches")),d=this._initialLocation.x,e=this._initialLocation.y,f=a.x,g=a.y,h=Math.sqrt((d-=f)*d+(e-=g)*e),i=Math.abs(h)<this._moveThreshold,j=b(this.touches,"timestamp"),k=j-this._initialTimestamp>=this.pressPeriodThreshold,l=i&&k;return l||(c(this,"state",Em.Gesture.CANCELLED),this.didCancel()),l},didEnd:function(){this._resetCounters()},didCancel:function(){this._resetCounters()},_resetCounters:function(){this._initialLocation=null,this._initialTimestamp=null},toString:function(){return Em.PressGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("press",Em.PressGestureRecognizer)}({}),function(a){var b=Em.get,c=Em.set;Em.TouchHoldGestureRecognizer=Em.Gesture.extend({holdPeriod:2e3,moveThreshold:50,gestureIsDiscrete:!0,_endTimeout:null,_targetElement:null,shouldBegin:function(){return b(this.touches,"length")===b(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(b(this.touches,"touches"));var a=b(this.touches,"touches")[0].target;c(this,"_target",a);var d=this;this._endTimeout=window.setTimeout(function(){d._endFired(d)},this.holdPeriod)},didChange:function(){var a=this.centerPointForTouches(b(this.touches,"touches")),d=this._initialLocation.x,e=this._initialLocation.y,f=a.x,g=a.y,h=Math.sqrt((d-=f)*d+(e-=g)*e),i=Math.abs(h)<this.moveThreshold;i||(this._disableEndFired(),c(this,"state",Em.Gesture.CANCELLED))},shouldEnd:function(){return this._disableEndFired(),c(this,"state",Em.Gesture.CANCELLED),this.didCancel(),!1},_endFired:function(){this._disableEndFired();if(this.state===Em.Gesture.BEGAN||this.state===Em.Gesture.CHANGED){c(this,"state",Em.Gesture.ENDED);var a=b(this,"name")+"End";this.attemptGestureEventDelivery(a)}},_disableEndFired:function(){window.clearTimeout(this._endTimeout)},toString:function(){return Em.TouchHoldGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("touchHold",Em.TouchHoldGestureRecognizer)}({}),function(a){var b=Em.get,c=Em.set;Em.SwipeGestureRecognizer=Em.Gesture.extend({cancelPeriod:100,swipeThreshold:50,initThreshold:5,direction:Em.OneGestureDirection.Right,numberOfRequiredTouches:1,swipeDirection:null,_initialLocation:null,_previousLocation:null,_cancelTimeout:null,didBecomePossible:function(){this._previousLocation=this.centerPointForTouches(b(this.touches,"touches"))},shouldBegin:function(){var a=this._previousLocation,c=this.centerPointForTouches(b(this.touches,"touches")),d=a.x,e=a.y,f=c.x,g=c.y,h=!1;return this.direction&Em.OneGestureDirection.Right&&(h=f-d>this.initThreshold),!h&&this.direction&Em.OneGestureDirection.Left&&(h=d-f>this.initThreshold),!h&&this.direction&Em.OneGestureDirection.Down&&(h=g-e>this.initThreshold),!h&&this.direction&Em.OneGestureDirection.Up&&(h=e-g>this.initThreshold),h},didBegin:function(){this._initialLocation=this.centerPointForTouches(b(this.touches,"touches"));var a=this;this._cancelTimeout=window.setTimeout(function(){a._cancelFired(a)},this.cancelPeriod)},didChange:function(){var a=this.centerPointForTouches(b(this.touches,"touches")),d=this._initialLocation.x,e=this._initialLocation.y,f=a.x,g=a.y,h=!1;this.direction&Em.OneGestureDirection.Right&&(h=f-d>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Right),!h&&this.direction&Em.OneGestureDirection.Left&&(h=d-f>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Left),!h&&this.direction&Em.OneGestureDirection.Down&&(h=g-e>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Down),!h&&this.direction&Em.OneGestureDirection.Up&&(h=e-g>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Up);if(h){this._disableCancelFired(),c(this,"state",Em.Gesture.ENDED);var i=b(this,"name")+"End";this.attemptGestureEventDelivery(i),this._resetState()}},shouldEnd:function(){return this._cancelFired(),!1},_cancelFired:function(){this._disableCancelFired(),c(this,"state",Em.Gesture.CANCELLED);var a=b(this,"name")+"Cancel";this.attemptGestureEventDelivery(a),this._resetState()},_disableCancelFired:function(){window.clearTimeout(this._cancelTimeout)},toString:function(){return Em.SwipeGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("swipe",Em.SwipeGestureRecognizer)}({}),function(a){}({}),function(a){Em.GestureDelegates=Em.Object.create({_delegates:{},add:function(a){this._delegates[a.get("name")]=a},find:function(a){return this._delegates[a]},clear:function(){this._delegates={}}})}({}),function(a){Em.GestureDelegate=Em.Object.extend({name:null,init:function(){this._super()},shouldReceiveTouch:function(a,b,c){return!0}})}({}),function(a){var b=Em.get,c=Em.set;Em.View.reopen({eventManager:null,init:function(){this._super();var a=Em.Gestures.knownGestures(),d=b(this,"eventManager");if(a&&!d){var e=[],f=Em.GestureManager.create({appGestureManager:Em.AppGestureManager});for(var g in a)if(this[g+"Start"]||this[g+"Change"]||this[g+"End"]){var h;this[g+"Options"]!==undefined&&typeof this[g+"Options"]=="object"?h=this[g+"Options"]:h={},h.name=g,h.view=this,h.manager=f,e.push(a[g].create(h))}c(f,"view",this),c(f,"gestures",e),c(this,"eventManager",f)}},unblockGestureRecognizer:function(){var a=b(this,"eventManager");a.appGestureManager.unblock(this)}})}({}),function(a){}({}),function(a){}({})
